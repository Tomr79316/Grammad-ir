# @configure_input@ 
# Copyright (C) 2003 Kevin P. Scannell <scannell@slu.edu>
#
# This is free software; see the file COPYING for copying conditions.  There is
# NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#

@SET_MAKE@

SHELL = @SHELL@

.SUFFIXES: .in .pl .pre .txt

prefix=@prefix@
exec_prefix = $(prefix)

bindir = $(exec_prefix)/bin
libexecdir = $(exec_prefix)/libexec
datadir = $(prefix)/share
localedir = $(datadir)/locale
PACKAGE_NAME = @PACKAGE_NAME@
TARBALL = @PACKAGE_TARNAME@
pkgdatadir = $(datadir)/$(PACKAGE_NAME)
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL@
AWK = @AWK@
CC = @CC@
CFLAGS = @CFLAGS@
DEFS = -DLOCALEDIR=\"$(localedir)\" @DEFS@
ECHO = echo
EGREP = @EGREP@
LEX = @LEX@
LEXLIB = @LEXLIB@
LEX_OUTPUT_ROOT = @LEX_OUTPUT_ROOT@
LN_S = @LN_S@
PERL = @PERL@
YACC = @YACC@
TEANGACHA = @TEANGACHA@
ALLPL = @ALLPL@
ALLIN = @ALLIN@
ALLOH = @ALLOH@
ALLMAC = @ALLMAC@
METAS = $(ALLMAC) gin.meta.sed aonchiall.meta.sed comhshuite.meta.sed eisceacht.meta.sed rialacha.meta.sed


all : allperl cuardach gr

cuardach : cuardach.o $(ALLOH) farc.o
	$(CC) -o cuardach $(CFLAGS) cuardach.o $(ALLOH) farc.o
	
cuardach.o : cuardach.c gettext.h
	$(CC) -c $(CFLAGS) $(DEFS) -DBSONRAI=\"$(pkgdatadir)\" cuardach.c

farc.o : farc.c
	$(CC) -c $(CFLAGS) $(DEFS) farc.c

farc.c : TEANGACHA farc.c.in
	for teanga in $(TEANGACHA); do \
		$(ECHO) "extern int my_tolower_$${teanga} (const char* w, int* pos, char* lowered);"; \
		$(ECHO) "extern int make_all_lowercase_$${teanga} (const char* w, char *lwr, int l, int u, int f);"; \
		$(ECHO) "extern int byte_to_markup_$${teanga} (const unsigned char c, char *fill, char *attrs);"; \
	done > seal0.sub
	for teanga in $(TEANGACHA); do \
		$(ECHO) "  else if (!strcmp (teanga, \"$${teanga}\"))"; \
		$(ECHO) "    return my_tolower_$${teanga} (w, pos, lowered);"; \
	done | sed '1s/else //' > seal1.sub
	for teanga in $(TEANGACHA); do \
		$(ECHO) "  else if (!strcmp (teanga, \"$${teanga}\"))"; \
		$(ECHO) "    return make_all_lowercase_$${teanga} (word, lowered, lowers, uppers, firstupper);"; \
	done | sed '1s/else //' > seal3.sub
	for teanga in $(TEANGACHA); do \
		$(ECHO) "  else if (!strcmp (teanga, \"$${teanga}\"))"; \
		$(ECHO) "    ret = byte_to_markup_$${teanga} (c, fill, attrs);"; \
	done | sed '1s/else //' > seal4.sub
	cat farc.c.in | sed "/Prototypes/r seal0.sub" | sed "/External 1/r seal1.sub" | sed "/External 3/r seal3.sub" | sed "/External 4/r seal4.sub" > farc.c
	rm -f seal*.sub

.in.pl :
	./rigeail $@ $(PERL)

.pre.pl :
	cat `echo "$<" | sed 's/\.pre/.txt/'` | sed 's/^\(<\([A-Z]\)[^>]*\)>/s\/<B><Z>(<[^>]*>)*\1.>(<[^>]*>)*<\\\/Z>([^<]*)<\\\/B>\/\1>$$3<\\\/\2>\/g;/' > $<.tmp
	cat "$<" | sed "s@PERLPATH@$(PERL)@" | sed "/UNIGRAMS/r $<.tmp" > $@
	rm -f $<.tmp

.txt.pre :
	touch $@

lastperl : $(METAS)
	touch lastperl $(ALLIN)

allperl : $(ALLIN) lastperl
	$(MAKE) $(ALLPL)

installcheck : FORCE
	@LC_ALL=C $(bindir)/gr --iomlan triail | sed "s/^[0-9]*: //" > triail.tmp
	@if diff triail.err triail.tmp; then $(ECHO) 'OK.'; else $(ECHO) 'Problem.'; fi
	@rm -f triail.tmp

install : all installdirs
	$(INSTALL_DATA) TEANGACHA $(pkgdatadir)/TEANGACHA
	$(INSTALL_PROGRAM) cuardach $(libexecdir)/cuardach
	$(INSTALL_PROGRAM) hilite.awk $(libexecdir)/hilite.awk
	$(INSTALL_PROGRAM) gr $(bindir)/gr
	for teanga in $(TEANGACHA); do \
		$(INSTALL_DATA) eile-$${teanga}.bs $(pkgdatadir)/eile-$${teanga}.bs; \
		$(INSTALL_DATA) focail-$${teanga}.bs $(pkgdatadir)/focail-$${teanga}.bs; \
		$(INSTALL_PROGRAM) giorr-$${teanga} $(libexecdir)/giorr-$${teanga}; \
	done
	for perlfile in $(ALLPL); do \
		$(INSTALL_PROGRAM) $$perlfile $(libexecdir)/$$perlfile; \
	done
	mv -f gr gr.sh
	cd po && $(MAKE) install

installdirs : mkinstalldirs
	./mkinstalldirs $(bindir) $(pkgdatadir) $(libexecdir)
#	chmod 755 $(bindir) $(pkgdatadir) $(libexecdir)

uninstall :
	rm -f $(pkgdatadir)/TEANGACHA
	rm -f $(libexecdir)/cuardach
	rm -f $(libexecdir)/hilite.awk
	rm -f $(bindir)/gr
	for teanga in $(TEANGACHA); do \
		rm -f $(pkgdatadir)/eile-$${teanga}.bs; \
		rm -f $(pkgdatadir)/focail-$${teanga}.bs; \
		rm -f $(libexecdir)/giorr-$${teanga}.bs; \
	done
	for perlfile in $(ALLPL); do \
		rm -f $(libexecdir)/$$perlfile; \
	done
	cd po && $(MAKE) uninstall

vim : FORCE
	cp -f ./gramadoir.vim ${HOME}/.vim/plugin

configure: configure.ac
	autoconf

Makefile gr : Makefile.in gr.in config.status TEANGACHA
	./config.status
	chmod 444 Makefile gr

config.status: configure
	./config.status --recheck

distclean :
	cd po && $(MAKE) distclean
	$(MAKE) topclean
	rm -f gr config.log config.status Makefile farc.c

topclean :
	$(MAKE) semiclean
	rm -f DEBUG.log cuardach cuardach*.o $(ALLPL) aparser eparser rparser FOCAIL FOCAIL.all lastperl farc.o *.c~

clean :
	cd po && $(MAKE) clean
	$(MAKE) topclean

semiclean :
	rm -f triail.html cabhair.o cabhair y.tab.* $(LEX_OUTPUT_ROOT).* aonchiall.y eisceacht.y rialacha.y triail.utf

###############################################
# Remaining targets are for use by developers #
###############################################

webhome = $(HOME)/public_html/$(PACKAGE_NAME)

installhtml :
	$(INSTALL_DATA) cuidiu.html $(webhome)
	$(INSTALL_DATA) eagar.html $(webhome)
	$(INSTALL_DATA) foirm.html $(webhome)
	$(INSTALL_DATA) form.html $(webhome)
	$(INSTALL_DATA) index.html $(webhome)
	$(INSTALL_DATA) iompar.html $(webhome)
	$(INSTALL_DATA) sios.html $(webhome)
	$(INSTALL_DATA) sonrai.html $(webhome)
	$(INSTALL_DATA) stair.html $(webhome)
	$(INSTALL_DATA) sampla.html $(webhome)

installweb :
	$(MAKE) installhtml
#	$(MAKE) neamhshuim
	$(INSTALL_DATA) gramadoir.dtd $(webhome)/../dtds
	$(INSTALL_DATA) gramadoir.lsm $(webhome)
#	$(INSTALL_DATA) $(HOME)/.neamhshuim $(pkgdatadir)/Neamhshuim
	bash runchoip

perl : FORCE
	bash buildperl ga Irish n

perldb : FORCE
	bash buildperl ga Irish y

debug : FORCE
	$(MAKE) all
	cat ./gr | sed -f debug.sed > gr-debug
	mv -f gr-debug gr

benchmark : FORCE
	@rm -f ./DEBUG.log
	@if gr --version | grep DEBUG > /dev/null; \
	then \
		benchcorp | gr --iomlan > /dev/null; \
		rm -f ./DEBUG?; \
		cat DEBUG.log | bash bmtabla >> ../eile/benchmarks; \
		vi ../eile/benchmarks; \
	else \
		echo "You need to \"make debug\" and \"make install\" first."; \
	fi

triail.html : FORCE
	gr --html triail > triail.html

maintainer-clean :
	$(MAKE) distclean
	rm -f *.bs

ChangeLog : FORCE
	cvs2cl.pl

dist : FORCE
	$(MAKE) ChangeLog
	$(MAKE) triail
	$(MAKE) triail.err
	$(LN_S) gr ../$(TARBALL)
	mv TEANGACHA TEANGACHA.bak
	cp TEANGACHA.dist TEANGACHA
	tar cvhf $(TARBALL).tar -C .. $(TARBALL)/ABOUT-NLS
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/aonchiall.meta.sed
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/cabhair.c
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/ChangeLog
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/comhshuite.meta.sed
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/config.guess
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/config.rpath
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/config.sub
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/configure
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/configure.ac
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/COPYING
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/cuardach.c
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/eisceacht.meta.sed
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/farc.c.in
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/gettext.h
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/gin.meta.sed
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/gr.in
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/gramadoir.dtd
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/gramadoir.el
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/gramadoir.vim
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/hilite.awk
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/install-sh
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/Makefile.in
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/mkinstalldirs
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/ponc.in.l
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/ponc.in.y
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/README
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/rialacha.meta.sed
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/rigeail
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/TEANGACHA
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/triail
	tar rvhf $(TARBALL).tar -C .. $(TARBALL)/triail.err
	cat TEANGACHA | sed '/^#/d; s/ .*//' | \
	while read teanga; do \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/aonchiall-$${teanga}.in; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/comhshuite-$${teanga}.in; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/cuardach-$${teanga}.c; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/eile-$${teanga}.bs; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/eisceacht-$${teanga}.in; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/focail-$${teanga}.bs; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/giorr-$${teanga}; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/macra-$${teanga}.meta.sed; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/rialacha-$${teanga}.in; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/unigram-$${teanga}.pre; \
		tar rvhf $(TARBALL).tar -C .. $(TARBALL)/unigram-$${teanga}.txt; \
	done
	cd po && $(MAKE) dist
	gzip $(TARBALL).tar
	chmod 444 $(TARBALL).tar.gz
	mv $(TARBALL).tar.gz $(webhome)
	rm -f ../$(TARBALL)
	mv -f TEANGACHA.bak TEANGACHA

triail : rialacha-ga.in
	@mv -f triail triail.bak
	@sed -n '/^#\./{s/^#\. //; p}' rialacha-ga.in > triail
	@if diff triail.bak triail; then echo "Unchanged."; else echo "Different."; fi

triail.err : FORCE
	rm -f triail.err
	LC_ALL=C gr --iomlan triail | sed 's/^[0-9]*: //' > triail.err

#############################################################################
#              LEXICON BUILDING
#############################################################################

ISPELLDIR = ${HOME}/gaeilge/ispell

# use "groom" instead of this directly (since it requires ispell personal, etc.)
FOCAIL-ga.all : FORCE
	Gin 12
	((cat ${HOME}/.ispell_gaeilge; cat ${HOME}/.biobla | ispell -dgaeilge -e3 | tr " " "\n" | $(EGREP) -v '\/' | aspell -dga -p${HOME}/.aspell.blank.pws -l) | sed 's/.*/& 44/'; cat FOCAIL) | LC_COLLATE=POSIX sort -u -k1,1 -k2,2n > FOCAIL-ga.all
	rm -f FOCAIL

CYSRC = ${HOME}/gaeilge/gramadoir/cy/bangor/cyall.txt
focail-cy.bs : $(CYSRC)
	$(MAKE) cabhair
	(cat $(CYSRC) | sed 's/ [0-9]*//' | uniq | wc -l | sed 's/^ *//'; cat $(CYSRC) | ./cabhair 0) > focail-cy.bs
	chmod 644 focail-cy.bs

# for convenience (from groom); but also ensures built in correct order
gafromdb : FORCE
	$(MAKE) focail-ga.bs
	$(MAKE) eile-ga.bs
	$(MAKE) earraidi-ga.bs

# use "groom" instead of this directly
focail-ga.bs : FOCAIL-ga.all
	$(MAKE) cabhair
	(cat FOCAIL-ga.all | sed 's/ [0-9]*//' | uniq | wc -l | sed 's/^ *//'; cat FOCAIL-ga.all | ./cabhair 0) > focail-ga.bs
	chmod 644 focail-ga.bs

focail-EN.bs : FORCE
	$(MAKE) cabhair
	cat ../en/FOCAIL.EN | LC_COLLATE=POSIX sort -u -k1,1 -k2,2n > FOCAIL-EN.all
	(cat FOCAIL-EN.all | sed 's/ [0-9]*//' | uniq | wc -l | sed 's/^ *//'; cat FOCAIL-EN.all | ./cabhair 0) > focail-EN.bs
	chmod 644 focail-EN.bs

focail-en.bs : FORCE
	$(MAKE) cabhair
	(cat ${ISPELLDIR}/bearla/ENWORDS | wc -l | sed 's/^ *//'; cat ${ISPELLDIR}/bearla/ENWORDS | sed 's/$$/ 1/' | ./cabhair 0) > focail-en.bs
	chmod 644 focail-en.bs

ATH = ${ISPELLDIR}/ispell-gaeilge/athfhocail

# use "groom" instead of this directly
eile-ga.bs : FORCE
	$(MAKE) cabhair
	sed 's/ .*//' FOCAIL-ga.all > ./tempfocail
	sed 's/ .*//' $(ATH) | keepif -n ./tempfocail latin-1 | sort -u | join $(ATH) - | LC_COLLATE=POSIX sort -k1,1 | sed 's/ /_/g; s/_/ /;' | ./cabhair 1 | $(EGREP) . > ./tempeile
	(cat ./tempeile | wc -l | sed 's/^[^0-9]*//'; cat ./tempeile) > ./eile-ga.bs
	rm -f tempeile tempfocail

EARR = ${ISPELLDIR}/ispell-gaeilge/gaelu ${ISPELLDIR}/ispell-gaeilge/earraidi

# use "groom" instead of this directly
earraidi-ga.bs : FORCE
	$(MAKE) cabhair
	sed 's/ .*//' FOCAIL-ga.all eile-ga.bs > ./tempfocail
	sort -k1,1 $(EARR) > ./tempsrc
	sed 's/ .*//' ./tempsrc | keepif -n ./tempfocail latin-1 | sort -u | join ./tempsrc - | LC_COLLATE=POSIX sort -k1,1 | sed 's/ /_/g; s/_/ /;' | ./cabhair 1 | $(EGREP) . > ./earraidi-ga.bs
	rm -f tempfocail tempsrc

cabhair : cabhair.o
	$(CC) -o cabhair $(CFLAGS) cabhair.o
	
cabhair.o : cabhair.c
	$(CC) -c $(CFLAGS) $(DEFS) cabhair.c

###############################################################################
#                     .IN FILE GRAMMAR/PARSER
###############################################################################


aonchiall.y : ponc.in.y
	cat ponc.in.y | sed "s/_TAIL_MACRO_/result/; s/_RESULT_MACRO_/POSTAG/" > aonchiall.y

eisceacht.y : ponc.in.y
	cat ponc.in.y | sed "s/_TAIL_MACRO_//; /^result/d" > eisceacht.y

rialacha.y : ponc.in.y
	cat ponc.in.y | sed "s/_TAIL_MACRO_/result/; s/_RESULT_MACRO_/MESSAGE | MESSAGEPLUS MESSAGEARG/" > rialacha.y

aparser : aonchiall.y ponc.in.l gettext.h
	$(LEX) ponc.in.l
	$(YACC) -d aonchiall.y
	$(CC) -c $(CFLAGS) $(DEFS) $(LEX_OUTPUT_ROOT).c y.tab.c
	$(CC) -o aparser $(CFLAGS) $(LEX_OUTPUT_ROOT).o y.tab.o $(LEXLIB)

eparser : eisceacht.y ponc.in.l gettext.h
	$(LEX) ponc.in.l
	$(YACC) -d eisceacht.y
	$(CC) -c $(CFLAGS) $(DEFS) $(LEX_OUTPUT_ROOT).c y.tab.c
	$(CC) -o eparser $(CFLAGS) $(LEX_OUTPUT_ROOT).o y.tab.o $(LEXLIB)

rparser : rialacha.y ponc.in.l gettext.h
	$(LEX) ponc.in.l
	$(YACC) -d rialacha.y
	$(CC) -c $(CFLAGS) $(DEFS) $(LEX_OUTPUT_ROOT).c y.tab.c
	$(CC) -o rparser $(CFLAGS) $(LEX_OUTPUT_ROOT).o y.tab.o $(LEXLIB)

poncin : aparser eparser rparser
	@$(ECHO) 'Checking aonchiall-ga.in'
	@cat aonchiall-ga.in | ./aparser
	@$(ECHO) 'Checking eisceacht-ga.in'
	@cat eisceacht-ga.in | ./eparser
	@$(ECHO) 'Checking rialacha-ga.in'
	@cat rialacha-ga.in | ./rparser

###############################################################################

stresstest : FORCE
	@mv stress.out stress.out.ok
	@mv stress.err stress.err.ok
	@./stress
	@if diff stress.err.ok stress.err && diff stress.out.ok stress.out; then $(ECHO) "OK."; rm -f *.ok; else $(ECHO) "Problem."; fi

counts : FORCE
	head -n 1 focail-ga.bs
	head -n 1 eile-ga.bs
	ncl comhshuite-ga.in
	ncl aonchiall-ga.in
	ncl rialacha-ga.in
	ncl eisceacht-ga.in

unigram-ga.txt :
	beocorp | gr --minic --iomlan > unigram-ga.txt

neamhshuim : FORCE
	cat ../../gnu/gnu/poglac ../ga/aspell/aspellbad.txt | LC_COLLATE=POSIX sort -u > /tmp/neamhshuim.tmp
	(cat /tmp/neamhshuim.tmp | wc -l | sed 's/^[^0-9]*//'; cat /tmp/neamhshuim.tmp) > ${HOME}/.neamhshuim

Lingua-GA-Gramadoir : FORCE
	h2xs -XA -C -b 5.8.0 -n Lingua::GA::Gramadoir

FORCE :
