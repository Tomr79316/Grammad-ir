#!/bin/bash
# @configure_input@
# This is the front-end to An GramadÛir, an Irish language grammar checker.
# Copyright (C) 2003 Kevin P. Scannell <scannell@slu.edu>
#
# This is free software; see the file COPYING for copying conditions.  There is
# NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#
# Usage: gr [OPTIONS] [FILES]
#
# This is a script for checking the grammar of Irish language text
# contained in the files specified on the command line, or read from
# standard input if no arguments are given.   The default behavior is
# to write a summary of possible errors to standard output.
#
# There are several command line options.  The --html command line argument
# produces HTML output which should resemble the terminal output when
# viewed in a standard web brower.  The --litriu argument tells gr to
# act like classical UNIX "spell" (or ispell -l), and the --xml argument
# writes the intermediate tagged XML stream to standard output for 
# development or debugging purposes.  By default, the script looks in the
# user's home directory for a file .neamhshuim of words to ignore while
# checking the spelling and grammar.  Use the --iomlan flag to disregard
# this file.  The standard GNU --version and --help options work in the 
# expected way.   The language of the text to be checked can be specified
# with --teanga=xx; the list of available language codes is in the file
# TEANGACHA.

# NOT internationalized
packageversion="@PACKAGE_VERSION@"
bugemail="@PACKAGE_BUGREPORT@"
TEXTDOMAINDIR="@prefix@/share/locale"
TEXTDOMAIN="@PACKAGE_NAME@"
TEANGACHA="@TEANGACHA@"
export TEXTDOMAINDIR TEXTDOMAIN

# title that prints to screen, not used as filename.  I'd also prefer
# that it not be localized even for non-Irish grammar checking.
CLAR='An GramadÛir'    
EXECUTABLE="${0##/*/}"
HELPCOMMAND="${EXECUTABLE} --help"

# All i18n strings collected here.  See gramadoir.pot for some 
# translation hints.
checking=`gettext -s "Currently checking %s"`
notfound=`gettext -s "There is no such file."`
isdir=`gettext -s "Is a directory"`
permissions=`gettext -s "Permission denied"`
usage1=`gettext -s "Usage: %s [OPTIONS] [FILES]"`
usage2=`gettext -s "    --litriu       write misspelled words to standard output"`
usage3=`gettext -s "    --html         produce HTML output for viewing in a web browser"`
usage4=`gettext -s "    --xml          write tagged XML stream to standard output, for debugging"`
usage5=`gettext -s "    --iomlan       report all errors (i.e. do not use ~/.neamhshuim)"`
usage8=`gettext -s "    --teanga=XX    specify the language of the text to be checked (default=ga)"`
usage6=`gettext -s "    --help         display this help and exit"`
usage7=`gettext -s "    --version      output version information and exit"`
stdinhelp=`gettext -s "If no file is given, read from standard input."`
bugreports=`gettext -s "Send bug reports to <%s>."`
versionstring=`gettext -s "version %s"`
gpl=`gettext -s "This is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE,\nto the extent permitted by law."`
tryhelp=`gettext -s "Try %s for more information."`
unknownopt=`gettext -s "unknown option"`
unsupported=`gettext -s "Language %s is not supported."`
ANAITHNIDSRL=`gettext -s "Unknown word (ignoring remainder in this sentence)"`
ANAITHNID=`gettext -s "Unknown word"`
BACHOIR=`gettext -s "You should use \/\1\/ here instead"`
CAIGHDEAN=`gettext -s "Non-standard form: perhaps use \/\1\/?"`
CLAOCHLU=`gettext -s "Initial mutation missing"`
NISEIMHIU=`gettext -s "Unnecessary lenition"`
PREFIXH=`gettext -s "Prefix \/h\/ missing"`
PREFIXT=`gettext -s "Prefix \/t\/ missing"`
SEIMHIU=`gettext -s "Lenition missing"`
URU=`gettext -s "Eclipsis missing"`

# i18n: grammatical errors.  See rialacha-*.in.
# If you port to another language, you won't translate these; instead
# they will be replaced completely with messages corresponding to
# the errors for your language.
loganu()
{
sed "
s/\"ANAITHNIDSRL/\"${ANAITHNIDSRL}/g
s/\"ANAITHNID/\"${ANAITHNID}/g
s/\"BACHOIR{\([^}]*\)}/\"${BACHOIR}/g
/CAIGHDEAN/s/_/ /g
s/\"CAIGHDEAN{\([^}]*\)}/\"${CAIGHDEAN}/g
s/\"CLAOCHLU/\"${CLAOCHLU}/g
s/\"NISEIMHIU/\"${NISEIMHIU}/g
s/\"PREFIXH/\"${PREFIXH}/g
s/\"PREFIXT/\"${PREFIXT}/g
s/\"SEIMHIU/\"${SEIMHIU}/g
s/\"URU/\"${URU}/g
"
}

TAB=`@AWK@ 'BEGIN{printf "\t";}'`

# this is what happens if --version is passed
# Do not translate "Copyright" per the GNU coding standards.
versionout()
{
printf "${CLAR}, ${versionstring}\n" "${packageversion}"
echo "Copyright (C) 2003 Kevin P. Scannell"
printf "${gpl}\n"
}

htmlversion()
{
echo "<p>"
printf "<a href=\"http://borel.slu.edu/gramadoir/\">${CLAR}</a>, ${versionstring}<br>\n" "${packageversion}"
echo "CÛipcheart/Copyright (C) 2003 <a href=\"http://borel.slu.edu/\">Kevin P. Scannell</a><br><br>"
echo "<i>"
printf "${gpl}\n"
echo "</i></p><hr>"
}

# this is what happens if --help is passed
helpout()
{
printf "${usage1}\n" "${EXECUTABLE}"
echo
echo "${usage2}"
echo "${usage3}"
echo "${usage4}"
echo "${usage5}"
echo "${usage6}"
echo "${usage7}"
echo
echo "${stdinhelp}"
echo
printf "${bugreports}\n" "${bugemail}"
}

# one argument, the erroneous option passed
option_error()
{
echo "${CLAR}: ${unknownopt} \`${1}'"
printf "${tryhelp}\n" "${HELPCOMMAND}"
}


# This function is intended to convert a utf-8 stream into ISO-8859-1.  I'm 
# assuming the input stream contains Irish text.  This is reasonable because 
# the actual grammar checking will be a terrible mess otherwise. 
diutf()
{
tr -d "\303" | tr "[\200-\277]" "[\300-\377]"
}

# strips any pre-existing markup, tokenizes with <c></c>,
# inserts line number markup, puts one sentence per line 
# final filter is there because of some indecision about
# whether I like the line number markups on the interiors of lines
abairti()
{
tr -d "\015" | @EGREP@ -n '^' | sed "
		s/<[^>]*>//g; 
		s/[&\<>]/ /g; 
		s/[A-Za-z·ÈÌÛ˙¡…Õ”⁄][A-Za-z·ÈÌÛ˙¡…Õ”⁄-]*/<c>&<\/c>/g; 
		s/\(--*\)<\/c>/<\/c>\1/g;
		s/<c>\([BDMbdm]\)<\/c>'<c>/<c>\1'/g;
		s/<c>\([Mm]b\)<\/c>'<c>/<c>\1'/g;
		s/^\([1-9][0-9]*\):/<line uimhir=\"\1\"> /; 
		s/\([^.][^.][^.][.?!][]\"\')}]*\) [ ${TAB}\n]*/\1 <\/line>\n/g;
		s/[^.][^.][^.][.?!][]\"\')}]*$/& <\/line>/" |
		athuimhir | athcheang |
		sed 's/\(.\)<line uimhir[^>]*>/\1/g'
}

# helper for abairti.  If a sentence starts in the middle of a line,
# need the line number tag to propagate down to the beginning of this
# sentence.  Thus, the first chunk below stores the line number markup 
# in hold space and the second chunk retrieves it and inserts at beginning
#  n.b. POSIX sed requires no whitespace after the "!" in the negated 
#  match below.    Discovered while porting to an old DEC machine.
athuimhir()
{
sed '
/^<line uimhir=/ {
h
s/^\(<line uimhir=\"[1-9][0-9]*\">\).*$/\1/
x
}

/^<line uimhir=/!{
G
s/^\(.*\)\n\(<line uimhir=\"[1-9][0-9]*\">\)$/\2 \1/
}

/^<line uimhir=\"[1-9][0-9]*\"> *$/d
'
}

# helper for abairti.  This is the "complement" to athuimhir, for when
# a sentence spans across lines.   It needs to be "rejoined" (athcheangailte).
# onto a single line.
athcheang()
{
sed "
/<\/line>$/ {
H
s/^.*$//
x
s/\n//g
s/[ ${TAB}][ ${TAB}]*/ /g
}

/<\/line>$/!{
H
d
}
"
}


# This is a filter which takes the markup generated by 
# looking up words in the dictionary and tries to resolve
# any ambiguties by looking at local context.
#
#  It is a sequence of sed replacements which are discovered
#  inductively by looking at examples of ambiguities in real
#  Irish texts.  It is important to order the replacements
#  according to their "confidence level"; while it is clear
#  that...     distinguishing between ...  is sometimes much harder.
aonchiall()
{
@PERL@ @prefix@/libexec/aonchiall-${TEANGA}.pl
}

# This is the workhorse.  It does the actually marking up of errors.
rialacha()
{
@PERL@ @prefix@/libexec/rialacha-${TEANGA}.pl
}

# This strips off errors from exceptions to rules
eisceacht()
{
@PERL@ @prefix@/libexec/eisceacht-${TEANGA}.pl
}

# This is the final filter used by the "gr" program.
# It generates a Bourne shell script which produces the
# final output.  It is the part I like the least and 
# users should feel free to replace it with their own
# front ends.
comheadan()
{
sed -n '
/<E/ {
h
s/^<line uimhir=\"\([1-9][0-9]*\)\">/echo "\1:/
s/<[^>]*>//g
s/\(["$`]\)/\\\1/g
s/^echo \\"/echo "/
s/$/" | myaibhsigh"(/
G
x
s/<[^E][^>]*>//g
s/^[^<]*</</
s/>[^<]*</></g
s/>[^<]*$/>/
s/<E[^>]*msg=\"\([^"]*\)\"[^>]*>/"\1," /g
s/^/echo /
s/,\" $/."; echo/
x
s/<[^E\/][^>]*>//g
s/<\/[^E][^>]*>//g
s/\n[^<]*</</
s/>[^<]*$/>/
s/<\/E>[^<]*<E/<\/E><E/g
s/<E[^>]*>\([^<]*\)<\/E>/\1|/g
s/<[^>]*>//g
s/|$/)"/
G
p
}
'
}

# does the error messaging and returns the boolean 
drochchomhad()
{
	if [ ! -e ${1} ]
	then
		echo "${CLAR}: ${1}: $notfound"
	else
		if [ -d ${1} ]
		then
			echo "${CLAR}: ${1}: $isdir" > 2
		else
			if [ ! -r ${1} ]
			then
				echo "${CLAR}: ${1}: $permissions" > 2
			fi
		fi
	fi
	[ ! -e ${1} ] || [ -d ${1} ] || [ ! -r ${1} ]    # return value
}

USEIGNORE="ignore"

# This is the main sequence of filters for checking a given file
# Either $1 is empty (stdin) or, if not, we've checked
# it exists, is not a directory, and is readable
comhad()
{
	cat $1 | diutf | 
		abairti |
		@prefix@/libexec/cuardach ${USEIGNORE} |
		aonchiall |
		rialacha |
		eisceacht |
		comheadan |
		@AWK@ "{sub(/myaibhsigh/,\"${AIBHSIGHVAR}\"); print}" |
		loganu |
		/bin/bash -s
}

# This replaces "comhad" above when "--xml" options is given
# same as filters in comhad up to the interface
xml_output()
{
	cat $1 | diutf |
		abairti |
		@prefix@/libexec/cuardach ${USEIGNORE} |
		aonchiall |
		rialacha |
		eisceacht
}

litriu_comheadan()
{
sed -n "
/<X>/{
s/<[^X\/][^>]*>//g
s/<\/[^X][^>]*>//g
s/^[^<]*<X>//
s/<\/X>[^<]*$//
s/<\/X>[^<]*<X>/\n/g
p
}
"
}

# This replaces "comhad" above when "--litriu" option is given
litriu()
{
	cat $1 | diutf |
		abairti |
		@prefix@/libexec/cuardach ${USEIGNORE} |
		litriu_comheadan
}

# remainder is the "main()"

AIBHSIGHVAR="@EGREP_COLOR@ "
ACTION=comhad
SCRIOBH_HTML=nihea
TEANGA=ga
while [ ${1%%[^-]*} ]
do
	if echo ${1} | grep "=" > /dev/null
	then
		JUSTOPT=`echo ${1} | sed 's/=.*//'`
		OPTARG=`echo ${1} | sed 's/^[^=]*=//'`
		case "${JUSTOPT}" in
		"--teanga" )
			if echo "${TEANGACHA}" | grep "${OPTARG}" > /dev/null
			then
				TEANGA="${OPTARG}"
			else
				printf "${unsupported}\n" ${OPTARG}
				exit 1
			fi
		;;
		* )
			option_error ${JUSTOPT}
		;;
		esac
	else
		case "${1}" in
		"--version" )
			if [ ${SCRIOBH_HTML} = "issea" ]
			then
				htmlversion
			else
				versionout
			fi
			exit 0
		;;
		"--help" )
			helpout
			exit 0
		;;
		"--html" )
			AIBHSIGHVAR="@AWK@ -f @prefix@/libexec/hilite.awk pattern="
			SCRIOBH_HTML=issea
		;;
		"--litriu" )
			ACTION=litriu
		;;
		"--xml" )
			ACTION=xml_output
		;;
		"--iomlan" )
			USEIGNORE="noignore"
		;;
		* )
			option_error ${1}
		;;
		esac
	fi
	shift
done

if [ -z "${1}" ]
then
	${ACTION}
else
	until [ -z "$1" ]
	do
		if ! drochchomhad ${1}
		then
			if [ ${ACTION} = "comhad" ]
			then
				printf "${checking}\n" ${1}
			fi
			${ACTION} ${1}
		fi	
		shift
	done
fi
exit 0
